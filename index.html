<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAXUTO - Tax Wizard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="validation-styles.css">

    <style>
        /* ✅ Tabs Bar Styles */
        .tabs-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #202124;
            z-index: 9999;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .tabs-bar.show {
            display: block;
        }

        .tabs-container {
            display: flex;
            align-items: center;
            padding: 8px 8px 0 8px;
        }

        .tabs-list {
            display: flex;
            gap: 4px;
            flex: 1;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .tab {
            background: #35363a;
            color: #9aa0a6;
            border-radius: 8px 8px 0 0;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 180px;
            max-width: 240px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .tab:hover {
            background: #3c4043;
        }

        .tab.active {
            background: #292a2d;
            color: white;
        }

        .tab-icon {
            font-size: 14px;
        }

        .tab-title {
            flex: 1;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-close {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: #9aa0a6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .tab.main-tab .tab-close {
            display: none;
        }

        /* ✅ Tab Panels */
        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* ✅ Alert Styles */
        .custom-alert-draggable {
            position: fixed;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10000;
        }

        .custom-alert-content-draggable {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            min-width: 400px;
            overflow: hidden;
        }

        .custom-alert-header-draggable {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: move;
            user-select: none;
        }

        .alert-drag-icon {
            font-size: 16px;
            opacity: 0.7;
        }

        .alert-title {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .alert-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .custom-alert-body-draggable {
            padding: 24px 20px;
            color: #374151;
        }

        .custom-alert-body-draggable p {
            margin: 0 0 12px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        .custom-alert-footer-draggable {
            padding: 16px 20px;
            background: #f9fafb;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .alert-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .alert-btn-action {
            background: #dc2626;
            color: white;
        }

        .alert-btn-action:hover {
            background: #b91c1c;
        }

        .alert-btn-cancel {
            background: white;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }

        .alert-btn-cancel:hover {
            background: #f3f4f6;
        }
    </style>
</head>

<body>

    <!-- ✅ Tabs Bar -->
    <div class="tabs-bar" id="tabsBar">
        <div class="tabs-container">
            <div class="tabs-list" id="tabsList">
                <!-- Tabs تضاف هنا ديناميكياً -->
            </div>
        </div>
    </div>

    <!-- ✅ Dynamic Panels -->
    <div id="dynamicPanels"></div>

    <!-- ✅ Main Panel -->
    <div class="container-main tab-panel active" id="panel-main-tab">
        <div class="container-content">
            <br/><br/><br/><br/>
            <button class="edit-btn-table" data-modal="modal-Zakat-Entities" style="float: inline-end;">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path
                        d="M5.8335 5.8335H5.00016C4.55814 5.8335 4.13421 6.00909 3.82165 6.32165C3.50909 6.63421 3.3335 7.05814 3.3335 7.50016V15.0002C3.3335 15.4422 3.50909 15.8661 3.82165 16.1787C4.13421 16.4912 4.55814 16.6668 5.00016 16.6668H12.5002C12.9422 16.6668 13.3661 16.4912 13.6787 16.1787C13.9912 15.8661 14.1668 15.4422 14.1668 15.0002V14.1668"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path
                        d="M13.3333 4.16676L15.8333 6.66676M16.9875 5.48759C17.3157 5.15938 17.5001 4.71424 17.5001 4.25009C17.5001 3.78594 17.3157 3.34079 16.9875 3.01259C16.6593 2.68438 16.2142 2.5 15.75 2.5C15.2858 2.5 14.8407 2.68438 14.5125 3.01259L7.5 10.0001V12.5001H10L16.9875 5.48759Z"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
            الاقرار الاصلي 
        </div>
    </div>

    <!-- ✅ Modal -->
    <div class="modal" id="modal-Zakat-Entities">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="modal-header">
                        <div class="section-header-m w-98">
                            <span class="section-header-text">Zakat On Investments Funds In Internal Entities</span>
                            <button class="modal-close">&times;</button>
                        </div>
                    </div>
                    <div class="mx-auto w-98">
                        <div class="table-container">
                            <table class="modal-table">
                                <thead>
                                    <tr>
                                        <th class="w-35px">
                                            <span class="primary-model-icon-table">
                                                <svg width="14" height="10" viewBox="0 0 14 10" fill="none"
                                                    xmlns="http://www.w3.org/2000/svg">
                                                    <rect x="3.00012" y="6" width="1.66667" height="8.16667"
                                                        rx="0.833333" transform="rotate(-90 3.00012 6)" fill="white" />
                                                </svg>
                                            </span>
                                        </th>
                                        <th class="text-center">Investment</th>
                                        <th class="text-center">Type</th>
                                        <th>Calculation</th>
                                        <th>Zakat Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="text" class="model-table-input" value="1" readonly></td>
                                        <td><input type="text" class="model-table-input text-center" value="Company A">
                                        </td>
                                        <td><input type="text" class="model-table-input text-center"
                                                value="Fund Investment"></td>
                                        <td>
                                            <button class="btn-calculation" data-type="sub-return">Sub-return</button>
                                            <button class="btn-calculation" data-type="manual">Manual</button>
                                        </td>
                                        <td><input type="text" class="model-table-input zakat-amount" value="0.00"
                                                readonly></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <div class="flex gap-10">
                    </div>
                    <div class="flex gap-10">
                        <button class="modal-btn button-save-modal">
                            <i class="fa-solid fa-check"></i> Confirm & apply
                        </button>
                        <button class="modal-btn button-close-modal"
                            onclick="this.closest('.modal').classList.remove('show')">
                            <i class="fa-solid fa-times"></i> close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="all-models.js"></script>
    <script>
        // ================================
        // ✅ Event listener لأزرار Calculation
        // ================================
        document.addEventListener('click', function (e) {
            const button = e.target.closest('.btn-calculation');
            if (!button) return;

            const type = button.dataset.type;
            const row = button.closest('tr');
            const zakatInput = row.querySelector('.zakat-amount');

            if (type === 'manual') {
                // ✅ تفعيل التعديل اليدوي
                zakatInput.readOnly = false;
                zakatInput.focus();
                zakatInput.select();
                zakatInput.style.background = '#fff3cd';
                zakatInput.style.borderColor = '#ffc107';

                button.style.background = '#10b981';
                button.style.color = '#fff';

                const otherBtn = row.querySelector('[data-type="sub-return"]');
                if (otherBtn) {
                    otherBtn.style.background = '';
                    otherBtn.style.color = '';
                }
            }
            else if (type === 'sub-return') {
                // ✅ تصفير القيمة
                if (zakatInput.value && zakatInput.value !== '0.00') {
                    zakatInput.value = '0.00';
                }

                // ✅ إظهار Alert
                showDraggableAlert(row);

                zakatInput.readOnly = true;
                zakatInput.style.background = '';
                zakatInput.style.borderColor = '';

                button.style.background = '#10b981';
                button.style.color = '#fff';

                const otherBtn = row.querySelector('[data-type="manual"]');
                if (otherBtn) {
                    otherBtn.style.background = '';
                    otherBtn.style.color = '';
                }
            }
        });

        // ================================
        // ✅ Alert قابل للسحب
        // ================================
        function showDraggableAlert(row) {
            const existingAlert = document.querySelector('.custom-alert-draggable');
            if (existingAlert) existingAlert.remove();

            const alert = document.createElement('div');
            alert.className = 'custom-alert-draggable';
            alert.innerHTML = `
                <div class="custom-alert-content-draggable">
                    <div class="custom-alert-header-draggable" id="alert-header">
                        <div class="alert-drag-icon">
                            <i class="fa-solid fa-grip-vertical"></i>
                        </div>
                        <div class="alert-title">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                            Sub-return Required
                        </div>
                        <button class="alert-close-btn" onclick="this.closest('.custom-alert-draggable').remove()">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    <div class="custom-alert-body-draggable">
                        <p>This calculation requires sub-return data from the subsidiary company.</p>
                        <p>Please ensure all subsidiary returns are filed before proceeding.</p>
                    </div>
                    <div class="custom-alert-footer-draggable">
                        <button class="alert-btn alert-btn-action" onclick="handleSubReturnAction(this)">
                            <i class="fa-solid fa-file-import"></i>
                            Import Sub-return
                        </button>
                        <button class="alert-btn alert-btn-cancel" onclick="this.closest('.custom-alert-draggable').remove()">
                            <i class="fa-solid fa-times"></i>
                            Cancel
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(alert);
            makeDraggable(alert);
        }

        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const header = element.querySelector('#alert-header');

            if (header) {
                header.onmousedown = dragMouseDown;
            }

            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
                element.style.right = 'auto';
                element.style.transform = 'none';
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        function handleSubReturnAction(button) {
            const alert = button.closest('.custom-alert-draggable');
            if (alert) alert.remove();

            const investmentInput = document.querySelector('.modal-table tbody tr:first-child td:nth-child(2) input');
            const companyName = investmentInput ? investmentInput.value : 'Company';

            openSubReturn(companyName);
        }

        // ================================
        // ✅ نظام Tabs
        // ================================
        let tabCounter = 0;
        let activeTabId = 'main-tab';
        let tabsInitialized = false;

        function openSubReturn(companyName) {
            if (!tabsInitialized) {
                initializeTabs();
                tabsInitialized = true;
            }

            const tabId = `tab-${++tabCounter}`;

            const existingTab = Array.from(document.querySelectorAll('.tab')).find(tab =>
                tab.querySelector('.tab-title')?.textContent === companyName
            );

            if (existingTab && existingTab.id !== 'main-tab') {
                switchTab(existingTab.id);
                return;
            }

            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.id = tabId;
            tab.innerHTML = `
                <i class="fa-solid fa-building tab-icon"></i>
                <span class="tab-title">${companyName}</span>
                <button class="tab-close" onclick="closeTab('${tabId}', event)">
                    <i class="fa-solid fa-times"></i>
                </button>
            `;
            tab.onclick = () => switchTab(tabId);

            document.getElementById('tabsList').appendChild(tab);

            const panel = document.createElement('div');
            panel.className = 'tab-panel';
            panel.id = `panel-${tabId}`;
            panel.innerHTML = getSubReturnContent(companyName, tabId);

            document.getElementById('dynamicPanels').appendChild(panel);

            switchTab(tabId);
        }

        function initializeTabs() {
            const tabsBar = document.getElementById('tabsBar');
            tabsBar.classList.add('show');

            const mainTab = document.createElement('div');
            mainTab.className = 'tab main-tab active';
            mainTab.id = 'main-tab';
            mainTab.innerHTML = `
                <i class="fa-solid fa-table tab-icon"></i>
                <span class="tab-title">Main Table</span>
                <button class="tab-close"></button>
            `;
            mainTab.onclick = () => switchTab('main-tab');

            document.getElementById('tabsList').appendChild(mainTab);

            const modalContent = document.querySelector('.modal-content');
            if (modalContent) {
                modalContent.style.paddingTop = '60px';
            }
        }

        function getSubReturnContent(companyName, tabId) {
            return `
                <div class="container-main" style="padding-top: 80px;">
                    <div class="container-content">
                        <div style="max-width: 900px; margin: 0 auto; padding: 40px 20px;">
                            <div style="text-align: center; margin-bottom: 50px;">
                                <div style="width: 120px; height: 120px; margin: 0 auto 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);">
                                    <i class="fa-solid fa-file-invoice" style="font-size: 60px; color: white;"></i>
                                </div>
                                <h1 style="font-size: 48px; font-weight: 800; color: #1f2937; margin-bottom: 16px;">مرحباً في الإقرار الجديد</h1>
                                <p style="font-size: 20px; color: #6b7280; margin-bottom: 8px;">${companyName}</p>
                                <p style="font-size: 16px; color: #9ca3af;">يرجى ملء البيانات المطلوبة أدناه</p>
                            </div>

                            <div style="background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                                <div style="margin-bottom: 30px;">
                                    <label style="display: block; font-size: 15px; font-weight: 600; color: #374151; margin-bottom: 8px;">رقم السجل التجاري *</label>
                                    <input type="text" class="model-table-input" id="cr-number-${tabId}" placeholder="أدخل رقم السجل" style="padding: 14px; font-size: 16px;">
                                </div>
                                <div style="margin-bottom: 30px;">
                                    <label style="display: block; font-size: 15px; font-weight: 600; color: #374151; margin-bottom: 8px;">الرقم الضريبي *</label>
                                    <input type="text" class="model-table-input" id="tax-id-${tabId}" placeholder="أدخل الرقم الضريبي" style="padding: 14px; font-size: 16px;">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                                    <div>
                                        <label style="display: block; font-size: 15px; font-weight: 600; color: #374151; margin-bottom: 8px;">الإيرادات *</label>
                                        <input type="text" class="model-table-input" id="revenue-${tabId}" placeholder="0.00" onblur="calculateSubReturnTotal('${tabId}')" style="padding: 14px; font-size: 16px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 15px; font-weight: 600; color: #374151; margin-bottom: 8px;">المصروفات *</label>
                                        <input type="text" class="model-table-input" id="expenses-${tabId}" placeholder="0.00" onblur="calculateSubReturnTotal('${tabId}')" style="padding: 14px; font-size: 16px;">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
                                    <div>
                                        <label style="display: block; font-size: 15px; font-weight: 600; color: #374151; margin-bottom: 8px;">صافي الربح</label>
                                        <input type="text" class="model-table-input" id="netprofit-${tabId}" value="0.00" readonly style="background: #f9fafb; padding: 14px; font-size: 16px; font-weight: 700;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 15px; font-weight: 600; color: #dc2626; margin-bottom: 8px;">مبلغ الزكاة</label>
                                        <input type="text" class="model-table-input" id="zakat-${tabId}" value="0.00" readonly style="background: #fef2f2; color: #dc2626; padding: 14px; font-size: 18px; font-weight: 700;">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 15px; justify-content: center;">
                                    <button onclick="closeTab('${tabId}')" style="padding: 14px 28px; background: white; border: 2px solid #e5e7eb; color: #6b7280; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px;">إلغاء</button>
                                    <button onclick="submitSubReturnData('${companyName}', '${tabId}')" style="padding: 14px 28px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px;">إرسال</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateSubReturnTotal(tabId) {
            const revenueInput = document.getElementById(`revenue-${tabId}`);
            const expensesInput = document.getElementById(`expenses-${tabId}`);
            const netProfitInput = document.getElementById(`netprofit-${tabId}`);
            const zakatInput = document.getElementById(`zakat-${tabId}`);

            if (revenueInput && expensesInput && netProfitInput && zakatInput) {
                const revenue = parseFloat(revenueInput.value.replace(/,/g, '')) || 0;
                const expenses = parseFloat(expensesInput.value.replace(/,/g, '')) || 0;
                const netProfit = revenue - expenses;
                const zakat = netProfit * 0.025;

                netProfitInput.value = formatNumber(netProfit);
                zakatInput.value = formatNumber(zakat);
            }
        }

        function submitSubReturnData(companyName, tabId) {
            const crNumber = document.getElementById(`cr-number-${tabId}`).value;
            const taxId = document.getElementById(`tax-id-${tabId}`).value;
            const revenue = document.getElementById(`revenue-${tabId}`).value;
            const expenses = document.getElementById(`expenses-${tabId}`).value;

            if (!crNumber || !taxId || !revenue || !expenses) {
                alert('⚠️ Please fill all required fields (*)');
                return;
            }

            const zakatValue = document.getElementById(`zakat-${tabId}`).value;

            const rows = document.querySelectorAll('.modal-table tbody tr');
            let applied = false;

            rows.forEach(row => {
                const investmentInput = row.querySelector('td:nth-child(2) input');
                if (investmentInput && investmentInput.value.trim() === companyName.trim()) {
                    const zakatInput = row.querySelector('.zakat-amount');
                    if (zakatInput) {
                        zakatInput.value = zakatValue;
                        zakatInput.style.background = '#d1fae5';
                        zakatInput.style.borderColor = '#10b981';

                        setTimeout(() => {
                            zakatInput.style.background = '';
                            zakatInput.style.borderColor = '';
                        }, 2000);

                        applied = true;
                    }
                }
            });

            closeTab(tabId);
            switchTab('main-tab');

            if (applied) {
                showToast('Success', `Data from ${companyName} applied successfully!`, 'success');
            }
        }

        function switchTab(tabId) {
            console.log('Switching to:', tabId);

            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

            const tab = document.getElementById(tabId);
            const panel = document.getElementById(`panel-${tabId}`);

            if (tab) {
                tab.classList.add('active');
                activeTabId = tabId;
            }

            if (panel) {
                panel.classList.add('active');
            }
        }

        function closeTab(tabId, event) {
            if (event) event.stopPropagation();
            if (tabId === 'main-tab') return;

            const tab = document.getElementById(tabId);
            const panel = document.getElementById(`panel-${tabId}`);

            const wasActive = tab && tab.classList.contains('active');

            if (tab) tab.remove();
            if (panel) panel.remove();

            if (wasActive) switchTab('main-tab');
        }

        function formatNumber(num) {
            return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function showToast(title, message, type = 'info') {
            const colors = { success: '#10B981', error: '#EF4444', info: '#3B82F6' };
            const toast = document.createElement('div');
            toast.style.cssText = `position: fixed; top: 80px; right: 20px; background: white; border-left: 4px solid ${colors[type]}; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); padding: 16px 20px; min-width: 300px; z-index: 10001;`;
            toast.innerHTML = `<div style="font-weight: 600; color: #1F2937; margin-bottom: 4px;">${title}</div><div style="font-size: 14px; color: #6B7280;">${message}</div>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>


    <script src="validation.js"></script>
    <script src="conditional-show-hide.js"></script>
    <script src="set-default-not-applicable.js"></script>
    <script src="wizard-complete.js"></script>

</body>

</html>